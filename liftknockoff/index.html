<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" >
    <link rel="stylesheet" href="style.css" type="text/css">
    <title>Car Service</title>
    <script>
            var myLat = 000;
            var myLng = 000;
            var map;
            
            function initMap() {
                 map = new google.maps.Map(document.getElementById('map'), {center: {lat: 42.405, lng: -71.119}, zoom: 15});
                 //use mapOptions to change the lat and long to make more sense later
                 getLocation();
            }
            
            function getLocation() {
                console.log("in getlocation");
                navigator.geolocation.getCurrentPosition(function(position){
                    console.log("in position");
                myLat = position.coords.latitude;
                myLng = position.coords.longitude;
                receiveLocations();
                console.log("lat and lng are " + myLat + ", " + myLng);
                });
            }

            function renderMap() {
                var me = new google.maps.LatLng(myLat, myLng);
                var infoWindow = new google.maps.InfoWindow();
               
                console.log("in render");
                map.panTo(me);
                console.log("creating a marker");
                var myMarker = new google.maps.Marker({
                    position: me,
                    icon: 'me.png',
                    title: "Brita!!"
                });

                myMarker.setMap(map);
                var content = '<p>Username: VFadwaWF</br>Location: ' + myLat + ', '+ myLng + '</p>';
                
                google.maps.event.addListener(myMarker, 'click', function(){
                    infoWindow.setContent(content);
                    infoWindow.open(map, myMarker);
                });
                console.log("before calling receive locations: lat and lng are " + myLat + ", " + myLng);
            }

            // not receiving json data
            function receiveLocations() {
                request = new XMLHttpRequest();
     
                request.open("POST", "https://hans-moleman.herokuapp.com/rides", true);
    
                request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
   
                request.onreadystatechange = function() {
                    if (request.readyState == 4 && request.status == 200) {
                        pplAndPlace = JSON.parse(request.responseText);
                        console.log(pplAndPlace);
                        console.log(pplAndPlace.vehicles.length);
                        var count;
                        for (count=0; count < pplAndPlace.vehicles.length; count++){
                            console.log("for loop");
                            if (pplAndPlace.vehicles[count].username == "WEINERMOBILE"){
                                console.log("if weinermobile");
                                var weinerMarker = new google.maps.Marker({
                                    position: new google.maps.LatLng(pplAndPlace.vehicles[count].lat, pplAndPlace.vehicles[count].lng),
                                    icon: 'weinermobile.png',
                                    title: "WEINERMOBILE"
                                });
                                weinerMarker.setMap(map);
                                var content = '<p>Username: ' + pplAndPlace.vehicles[count].username + '</br>Distance from me: </p>';
                                var infoWindow = new google.maps.InfoWindow();
                                google.maps.event.addListener(weinerMarker, 'click', function(){
                                    infoWindow.setContent(content);
                                    infoWindow.open(map, weinerMarker);
                                });
                            } else {
                                var vehicleMarker = new google.maps.Marker({
                                    position: new google.maps.LatLng(pplAndPlace.vehicles[count].lat, pplAndPlace.vehicles[count].lng),
                                    icon: 'car.png',
                                    title: "Vehicle"
                                });
                                vehicleMarker.setMap(map);
                                var content = '<p>Username: ' + pplAndPlace.vehicles[count].username + '</br>Distance from me: </p>';
                                var infoWindow = new google.maps.InfoWindow();
                                google.maps.event.addListener(vehicleMarker, 'click', function(){
                                    infoWindow.setContent(content);
                                    infoWindow.open(map, vehicleMarker);
                                });
                                console.log("in vehicle marker setup");
                            }
                        }
                        console.log("after for loop");
                    }
                }
                console.log("mylat: " + myLat + " mylng: " + myLng);
                request.send("username=VFadwaWF&lat="+myLat+"&lng="+myLng);
                renderMap();
            } 
    </script> 
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC9sQaGQMUn1TEZG3C11LjRlpQAppS4WGk&callback=initMap" async defer></script> 
    <!-- link with my API key: (error keeps telling me I need to activate it?)-->
    <!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBwUBWoCug3Rd4myBqKkSHOAc2rCWEYiO0&callback=initMap" async defer></script> -->

</head>

<body onload="initMap()">
    <div id="map"></div>
    <h1>hi world</h1>
</body>
</html>